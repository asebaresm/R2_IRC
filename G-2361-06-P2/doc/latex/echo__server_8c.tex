\hypertarget{echo__server_8c}{\section{src/echo\-\_\-server.c File Reference}
\label{echo__server_8c}\index{src/echo\-\_\-server.\-c@{src/echo\-\_\-server.\-c}}
}


Servidor echo utilizado para aprendizaje y pruebas con sockets.  


{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$unistd.\-h$>$}\\*
{\ttfamily \#include $<$stdlib.\-h$>$}\\*
{\ttfamily \#include $<$string.\-h$>$}\\*
{\ttfamily \#include $<$netdb.\-h$>$}\\*
{\ttfamily \#include $<$sys/types.\-h$>$}\\*
{\ttfamily \#include $<$sys/socket.\-h$>$}\\*
{\ttfamily \#include $<$netinet/in.\-h$>$}\\*
{\ttfamily \#include $<$arpa/inet.\-h$>$}\\*
{\ttfamily \#include $<$pthread.\-h$>$}\\*
{\ttfamily \#include $<$errno.\-h$>$}\\*
Include dependency graph for echo\-\_\-server.\-c\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{echo__server_8c__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{echo__server_8c_aeca034f67218340ecb2261a22c2f3dcd}{B\-U\-F\-S\-I\-Z\-E}~1024
\item 
\#define \hyperlink{echo__server_8c_a3e4b4faa36cc9e3a7d9895aec8f27592}{M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q}~10
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{echo__server_8c_aad9796c174f7ef5d226cd169f2520fd5}{error} (char $\ast$msg)
\item 
int \hyperlink{echo__server_8c_a0ddf1224851353fc92bfbff6f499fa97}{main} (int argc, char $\ast$argv\mbox{[}$\,$\mbox{]})
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Servidor echo utilizado para aprendizaje y pruebas con sockets. \begin{DoxyAuthor}{Author}
Alfonso Sebares 

Beatriz de Pablo 

Celia Mateos 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
13/02/17 
\end{DoxyDate}


\subsection{Macro Definition Documentation}
\hypertarget{echo__server_8c_aeca034f67218340ecb2261a22c2f3dcd}{\index{echo\-\_\-server.\-c@{echo\-\_\-server.\-c}!B\-U\-F\-S\-I\-Z\-E@{B\-U\-F\-S\-I\-Z\-E}}
\index{B\-U\-F\-S\-I\-Z\-E@{B\-U\-F\-S\-I\-Z\-E}!echo_server.c@{echo\-\_\-server.\-c}}
\subsubsection[{B\-U\-F\-S\-I\-Z\-E}]{\setlength{\rightskip}{0pt plus 5cm}\#define B\-U\-F\-S\-I\-Z\-E~1024}}\label{echo__server_8c_aeca034f67218340ecb2261a22c2f3dcd}
Tam. max. del buffer que se lee \hypertarget{echo__server_8c_a3e4b4faa36cc9e3a7d9895aec8f27592}{\index{echo\-\_\-server.\-c@{echo\-\_\-server.\-c}!M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q@{M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q}}
\index{M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q@{M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q}!echo_server.c@{echo\-\_\-server.\-c}}
\subsubsection[{M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q}]{\setlength{\rightskip}{0pt plus 5cm}\#define M\-A\-X\-\_\-\-C\-O\-N\-\_\-\-R\-E\-Q~10}}\label{echo__server_8c_a3e4b4faa36cc9e3a7d9895aec8f27592}
Max. de peticiones de conexion activas (e.\-g. la 11 falla si puesto a 10) 

\subsection{Function Documentation}
\hypertarget{echo__server_8c_aad9796c174f7ef5d226cd169f2520fd5}{\index{echo\-\_\-server.\-c@{echo\-\_\-server.\-c}!error@{error}}
\index{error@{error}!echo_server.c@{echo\-\_\-server.\-c}}
\subsubsection[{error}]{\setlength{\rightskip}{0pt plus 5cm}void error (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{msg}
\end{DoxyParamCaption}
)}}\label{echo__server_8c_aad9796c174f7ef5d226cd169f2520fd5}

\begin{DoxyCode}
26                       \{
27         perror(msg);
28         exit(1);
29 \}
\end{DoxyCode}
\hypertarget{echo__server_8c_a0ddf1224851353fc92bfbff6f499fa97}{\index{echo\-\_\-server.\-c@{echo\-\_\-server.\-c}!main@{main}}
\index{main@{main}!echo_server.c@{echo\-\_\-server.\-c}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$}]{argv\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}}\label{echo__server_8c_a0ddf1224851353fc92bfbff6f499fa97}

\begin{DoxyCode}
32 \{
33         \textcolor{keywordtype}{int} socket\_desc , client\_sock , c , read\_size;
34         \textcolor{keywordtype}{int} portno;
35         \textcolor{keywordtype}{int} optval; \textcolor{comment}{/* flag value for setsockopt */}
36         \textcolor{keyword}{struct }sockaddr\_in server , client;
37         \textcolor{keyword}{struct }hostent *hostp; \textcolor{comment}{/* client host info */}
38         \textcolor{keywordtype}{char} client\_message[\hyperlink{echo__server_8c_aeca034f67218340ecb2261a22c2f3dcd}{BUFSIZE}];
39         \textcolor{keywordtype}{char} *hostaddrp; \textcolor{comment}{/* dotted decimal host addr string */}
40          
41         \textcolor{keywordflow}{if} (argc != 2) \{
42                 fprintf(stderr, \textcolor{stringliteral}{"usage: %s <port>\(\backslash\)n"}, argv[0]);
43                 exit(1);
44         \}
45         portno = atoi(argv[1]);
46         
47         \textcolor{comment}{//Create socket}
48         socket\_desc = socket(AF\_INET , SOCK\_STREAM , 0);
49         \textcolor{keywordflow}{if} (socket\_desc == -1)
50         \{
51                 printf(\textcolor{stringliteral}{"Could not create socket"});
52         \}
53         puts(\textcolor{stringliteral}{"Socket created"});
54         
55         optval = 1;
56         setsockopt(socket\_desc, SOL\_SOCKET, SO\_REUSEADDR, (\textcolor{keyword}{const} \textcolor{keywordtype}{void} *)&optval , \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));
57 
58         \textcolor{comment}{//Prepare the sockaddr\_in structure}
59         memset((\textcolor{keywordtype}{char} *) &server, 0, \textcolor{keyword}{sizeof}(server));
60         server.sin\_family = AF\_INET;
61         server.sin\_addr.s\_addr = INADDR\_ANY;
62         server.sin\_port = htons((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short})portno );
63          
64         \textcolor{comment}{//Bind}
65         \textcolor{keywordflow}{if}( bind(socket\_desc,(\textcolor{keyword}{struct} sockaddr *)&server , \textcolor{keyword}{sizeof}(server)) < 0)
66         \{
67                 \textcolor{comment}{//print the error message}
68                 \textcolor{comment}{//printf("\(\backslash\)nstrerror: %s\(\backslash\)n", strerror(errno));}
69                 perror(\textcolor{stringliteral}{"bind failed. Error"});
70                 \textcolor{keywordflow}{return} 1;
71         \}
72         puts(\textcolor{stringliteral}{"bind done"});
73          
74         \textcolor{comment}{//Listen}
75         listen(socket\_desc , \hyperlink{echo__server_8c_a3e4b4faa36cc9e3a7d9895aec8f27592}{MAX\_CON\_REQ});
76          
77         \textcolor{comment}{//Accept and incoming connection}
78         puts(\textcolor{stringliteral}{"Waiting for incoming connections..."});
79         c = \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct }sockaddr\_in);
80          
81         \textcolor{comment}{//accept connection from an incoming client}
82         client\_sock = accept(socket\_desc, (\textcolor{keyword}{struct} sockaddr *)&client, (socklen\_t*)&c);
83         \textcolor{keywordflow}{if} (client\_sock < 0)
84         \{
85                 perror(\textcolor{stringliteral}{"accept failed"});
86                 \textcolor{keywordflow}{return} 1;
87         \}
88 
89         hostp = gethostbyaddr((\textcolor{keyword}{const} \textcolor{keywordtype}{char} *)&client.sin\_addr.s\_addr, \textcolor{keyword}{sizeof}(client.sin\_addr.s\_addr), 
      AF\_INET);
90         \textcolor{keywordflow}{if} (hostp == NULL)
91                 \hyperlink{echo__server_8c_aad9796c174f7ef5d226cd169f2520fd5}{error}(\textcolor{stringliteral}{"ERROR on gethostbyaddr"});
92 
93         hostaddrp = inet\_ntoa(client.sin\_addr);
94 
95         \textcolor{keywordflow}{if} (hostaddrp == NULL)
96                 \hyperlink{echo__server_8c_aad9796c174f7ef5d226cd169f2520fd5}{error}(\textcolor{stringliteral}{"ERROR on inet\_ntoa\(\backslash\)n"});
97         printf(\textcolor{stringliteral}{"\(\backslash\)nserver established connection with %s (%s)\(\backslash\)n"}, hostp->h\_name, hostaddrp);
98          
99         \textcolor{comment}{//Receive a message from client}
100         \textcolor{keywordflow}{while}( strcmp(client\_message, \textcolor{stringliteral}{"\_STOP\_"}) != 0 )
101         \{
102                 read\_size = recv(client\_sock , client\_message , \hyperlink{echo__server_8c_aeca034f67218340ecb2261a22c2f3dcd}{BUFSIZE} , 0);
103                 printf(\textcolor{stringliteral}{"\(\backslash\)nRecibido: %s"}, client\_message);
104                 \textcolor{keywordflow}{if} (read\_size < 0)\{
105                         perror(\textcolor{stringliteral}{"recv failed"});
106                 \}
107                 \textcolor{comment}{//Send the message back to client}
108                 \textcolor{comment}{//write(client\_sock , client\_message , read\_size);}
109                 \textcolor{comment}{/*afinar un poco mas que mandar siempre BUFSIZE:*/}
110                 write(client\_sock , client\_message , strlen(client\_message)+1); 
111         \}
112         
113         puts(\textcolor{stringliteral}{"Client disconnected"});
114         fflush(stdout);
115         close(client\_sock);
116          
117         \textcolor{keywordflow}{return} 0;
118 \}\end{DoxyCode}


Here is the call graph for this function\-:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=190pt]{echo__server_8c_a0ddf1224851353fc92bfbff6f499fa97_cgraph}
\end{center}
\end{figure}


